## Licensed to Marvelution under one or more contributor license 
## agreements.  See the NOTICE file distributed with this work 
## for additional information regarding copyright ownership.
## Marvelution licenses this file to you under the Apache License,
## Version 2.0 (the "License"); you may not use this file except
## in compliance with the License.
## You may obtain a copy of the License at
##
##  http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing,
## software distributed under the License is distributed on an
## "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
## KIND, either express or implied. See the License for the
## specific language governing permissions and limitations
## under the License.

#macro(showLink $selectedSubTab $thisSubTab)
#set ($i18nTitle = "hudson.panel.${thisSubTab}.${moduleKey}.title")
#if ($selectedSubTab == $thisSubTab)
    ${i18n.getText($i18nTitle)}
#else
    <a id="hudson_tab_panel_tab_link" href="${req.contextPath}${baseLinkUrl}&selectedSubTab=${thisSubTab}">${i18n.getText($i18nTitle)}</a>
#end
#end

#if ($isAdmin)
	#if ($isAssociated)
		#set($type = 'edit')
	#else
		#set($type = 'add')
	#end
	<div id="quicklinks">
		<ul class="operations">
			<li class="aui-dd-parent">
				<a href="#" id="associationButton" class="lnk icon-${type}"><span>$i18n.getText("hudson.panel.${type}.association")</span></a>
			</li>
		</ul>
	</div>
#end

<div class="projectPanel" id="hudsonTabPanel">
	<div id="hudsonTabPanelHeader">
		<h3 class="formtitle">
			#if ($showRss)
			<a id="showRssLink" href="${req.contextPath}/secure/ViewHudsonServerPanelContent!showRss.jspa?${querySection}" class="actionLinks" style="display: none;"><img src="${req.contextPath}${baseResourceUrl}/images/rss.gif" alt="${i18n.getText('hudson.panel.title.rss.description')}" /></a>
			#end
			<img src="${req.contextPath}${baseResourceUrl}/images/hudson-icon-24.png" />
			<a href="${hudsonServer.host}">${hudsonServer.name}</a>
		</h3>
	</div>
	<div id="hudsonTabPanelDescription">
		<p>
			#set ($i18nDescription = "hudson.panel.${moduleKey}.$!{extraDescriptionKey}description")
			${i18n.getText($i18nDescription)}
        </p>
		#if ($availableTabs && !$availableTabs.isEmpty())
        <ul class="square">
            <li>
                <strong>${i18n.getText("common.concepts.view")}:</strong>
                #foreach ($subTab in $availableTabs)
                    #showLink(${selectedSubTab} ${subTab})  #if($velocityCount < $availableTabs.size()) | #end
                #end
            </li>
        </ul>
        #end
	</div>
	<div class="spaced" id="hudsonTabPanelBuilds">
		<img src="${req.ContextPath}/images/icons/wait-large.gif" class="waitingImage" />
	</div>
	<script type="text/javascript" >
		## dataType = 'html' will evaluate the included JS tags - http://docs.jquery.com/Ajax/jQuery.ajax#options
		jQuery.ajax({
			type : "GET",
			dataType: "html",
			url : "${req.contextPath}/secure/ViewHudsonServerPanelContent.jspa?${querySection}",
			success : function(html) {
				jQuery('#hudsonTabPanelBuilds').html(html);
			}
		});
	</script>
</div>
#if ($isAdmin)
<div class="hidden">
	<div id="associationDialog">
		<p>$i18n.getText("hudson.panel.${type}.association.description")</p>
		<table>
			<tr>
				<td class="field-row">
					<label for="hudsonServerId">$i18n.getText("hudson.config.server"):</label>
				</td>
				<td>
					<select id="hudsonServerId" name="hudsonServerId" style="width: 100%;" size="1">
					#foreach ($server in $servers)
					<option value="${server.serverId}" #if (${server.serverId} == ${currentAssociatedHudsonServerId}) selected="selected"#end>${server.name}</option>
					#end
					</select>
				</td>
			<tr>
		</table>
    </div>
</div>

<script type="text/javascript">
jQuery("#associationButton").click(function(event) {
	var popup = new AJS.Dialog(400, 200);
	popup.addHeader("${i18n.getText("hudson.panel.${type}.association")}");
	popup.addPanel("Panel 1", "panel1");
	popup.getCurrentPanel().body.append(AJS.$("#associationDialog"));
	popup.addButton("${i18n.getText("common.forms.cancel")}", function (dialog) {
		dialog.hide();
	});
	popup.addButton("${i18n.getText("common.forms.save")}", function (dialog) {
		var hudsonServerId = jQuery("#hudsonServerId").val();
		jQuery.ajax({
			type : "POST",
			async: false,
			dataType: "text",
			data: ({
				hudsonServer: hudsonServerId
			}),
			url : contextPath + "/rest/hudson/1.0/association/${projectKey}/",
			success: function() {
				dialog.hide();
				location.reload();
			},
			error: function() {
				alert("${i18n.getText("hudson.panel.association.failed")}");
			}
		});
	});
	popup.gotoPage(0);
	popup.gotoPanel(0);
	popup.show();
	event.preventDefault();
});
</script>
#end
